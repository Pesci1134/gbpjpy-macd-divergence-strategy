#  バックテスト実行ガイド

## 概要

バックテスト実行手順をまとめます。

---

## 制約条件

- パラメータの最適化は行わない
- 条件の追加・変更は行わない
- 指定された仮説をそのまま検証する
- 前提が不明確な場合は、勝手に補完せず必ず質問する
- 「改善案」は求めていない（あくまで現状ロジックの再現と検証のみを行う）

---

## 環境準備

### 1. 仮想環境の有効化

```bash
cd /Users/emayusuke/Desktop/トレード戦略_claude
source venv/bin/activate
```

### 2. 必要なライブラリ

- pandas
- numpy

---

## ファイル構成

```
scripts/ver7/
├── run_backtest_v7.py    # バックテスト実行スクリプト
├── backtest_engine_v7.py # バックテストエンジン（コアロジック）
├── indicators_v7.py      # インジケーター計算（RCI, EMA, MACD, ZigZag, ATR）
└── config_v7.py          # 設定パラメータ
```

---

## バックテスト実行方法

### コマンド

**プロジェクトルートから実行**（重要）:

```bash
cd /Users/emayusuke/Desktop/トレード戦略_claude
source venv/bin/activate
python scripts/ver7/run_backtest_v7.py
```

※ スクリプトは相対パスでデータを読み込むため、必ず**プロジェクトルート**から実行してください。

---

## 設定パラメータ（config_v7.py）

### インジケーター設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| RCI_SHORT | 9 | RCI短期期間 |
| RCI_MID | 14 | RCI中期期間 |
| RCI_OVERBOUGHT | 60 | RCI買われすぎ閾値 |
| RCI_MID_OVERBOUGHT | 40 | RCI中期閾値 |
| MACD_FAST | 6 | MACD短期EMA |
| MACD_SLOW | 13 | MACD長期EMA |
| MACD_SIGNAL | 4 | MACDシグナル |
| EMA_SHORT | 50 | 4時間足トレンド判定用EMA |

### ZigZag設定

| パラメータ | 値 | 用途 |
|-----------|-----|------|
| ZIGZAG_1H_DEPTH | 12 | 1時間足ダイバージェンス検出 |
| ZIGZAG_5M_DEPTH | 5 | 5分足SL設定 |

### SL/TP設定（ATRベース）

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| SL_ATR_LENGTH | 14 | ATR計算期間 |
| SL_ATR_MULT | 1.0 | ZigZagからのバッファ（ATR倍率） |
| SL_FALLBACK_ATR_MULT | 2.0 | ZigZagがない場合のデフォルト |
| SL_MIN_ATR_MULT | 0.5 | SL最小距離 |
| RISK_REWARD_RATIO | 1.5 | リスクリワード比 |

### 取引設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| TRADING_START_HOUR | 8 | 取引開始時間（JST） |
| TRADING_END_HOUR | 24 | 取引終了時間（JST） |
| DIVERGENCE_VALID_HOURS | 12 | ダイバージェンス有効期間 |
| ENABLE_1DIV1ENTRY | True | 1ダイバージェンス1エントリー制限 |

---

## 出力ファイル

バックテスト結果は、**実行回ごとに新規ディレクトリを作成**して保存します。  
例）`results_v7_20260114_run1/` のように、日付やパターン名を付けて保管してください。

（従来の固定ディレクトリ `results_v7/` ではなく、回ごとに `results_v*` で新規作成する運用に変更）

```
例: results_v7_20260114_run1/
├── backtest_report_v7.txt
├── trades_v7.csv
└── divergences_v7.csv
```

| ファイル | 内容 |
|---------|------|
| backtest_report_v*.txt | サマリー統計（総トレード数、勝率、期待値、最大DD、PF など） |
| trades_v*.csv | 全トレード一覧（エントリー/エグジット時刻・価格、保有時間、損益%/金額など） |
| divergences_v*.csv | 検出ダイバージェンス一覧 |

---

## 実行環境の保存

再現性確保のため、各バックテスト実行ごとに以下を同じディレクトリ（例: `results_v7_20260114_run1/`）へ保存してください。

- `python --version` の出力
- `pip freeze` の出力（使用ライブラリのバージョン）
- 実行時の Git コミットハッシュ（`git rev-parse HEAD`）
- 使用したPythonスクリプトのスナップショット：
  - `run_backtest_v7.py`: バックテスト実行エントリーポイント
  - `backtest_engine_v7.py`: バックテストのコアロジック（エントリー/決済など）
  - `indicators_v7.py`: 指標計算（RCI, EMA, MACD, ZigZag, ATR）
  - `config_v7.py`: パラメータ設定ファイル

## 結果の見方

### 主要指標

- **勝率**: 勝ちトレード数 / 総トレード数
- **プロフィットファクター (PF)**: 総利益額 / 総損失額（1.5以上が目安）
- **平均利益**: 1トレードあたりの平均pips

### 決済内訳

- **TP決済**: 利確到達
- **SL決済**: 損切り到達

### ダイバージェンスタイプ

- **ヒドゥン型**: トレンド継続シグナル（推奨）
- **レギュラー型**: 反転シグナル

---

## PineScriptとの同期

### RCI計算

PythonとPineScriptは同じRCI計算ロジックを使用：

```python
# Python (indicators_v7.py)
rank_price = 1 + less + (equal - 1) / 2.0  # 平均順位方式
rank_time = idx + 1
```

```pine
// PineScript
rank_price = 1 + less + (equal - 1) / 2.0  // 平均順位
rank_time = i + 1
```

---

## トラブルシューティング

### エラー: FileNotFoundError

```
FileNotFoundError: No such file or directory: './ローソク足データ/...'
```

**対処**: プロジェクトルートから実行してください。

### 勝率が低い場合

SL設定を確認：
- `SL_ATR_MULT` を大きくするとSLが遠くなる
- `SL_MIN_ATR_MULT` を小さくすると最小SL距離が縮まる

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-14 | 初版作成 |
